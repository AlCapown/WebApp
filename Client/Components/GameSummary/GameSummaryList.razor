@using Microsoft.AspNetCore.Components.Web.Virtualization
@using WebApp.Client.Common.Extensions
@using WebApp.Client.Components.Common.WebAppComponentBase
@using WebApp.Client.Store.GameStore
@using WebApp.Common.Enums
@using WebApp.Common.Models

@inherits WebAppComponentBase

@inject IState<GameState> GameState

<MudGrid>
    <Virtualize Items="Games" Context="GameId" OverscanCount="2" ItemSize="500">
        <MudItem xs="12">
            <GameSummary GameId="GameId" />
        </MudItem>
    </Virtualize>
</MudGrid>


@code 
{
    #nullable enable

    [Parameter, EditorRequired]
    public int SeasonId { get; set; }

    [Parameter, EditorRequired]
    public int TeamId { get; set; }

    protected override void OnInitialized()
    {
        MaybeDispatch(new GameActions.SearchGamesForSeason
        {
            SeasonId = SeasonId,
            TeamId = TeamId
        });

        base.OnInitialized();
    }

    private int[] Games => GameState.Value.Games.Values
        .Where(x => x.SeasonId == SeasonId)
        .Where(x => x.HomeTeamId == TeamId || x.AwayTeamId == TeamId)
        .Where(x => x.SeasonWeekTypeName == WeekType.RegularSeason)
        .Where(x => x.IsComplete)
        .Where(x => x.HasSummary)
        .OrderByDescending(x => x.GameStartsOn)
        .Select(x => x.GameId)
        .ToArray();

}
