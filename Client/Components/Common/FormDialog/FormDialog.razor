@using Fluxor.Blazor.Web.Components
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@using System
@using System.Threading.Tasks
@using WebApp.Client.Store.PageStore
@using WebApp.Common.Models
@using WebApp.Common.Extensions

@implements IDisposable

<EditForm Model="@Model" OnValidSubmit="@OnValidSubmitAsync">
    <MudDialog Class="wa_formDialog">
        <TitleContent>
            <MudText Typo="Typo.h6" Align="Align.Center">
                @Title  
            </MudText>
            @if (!string.IsNullOrWhiteSpace(SubTitle))
            {
                <MudText Typo="Typo.subtitle1" Align="Align.Center">
                    @SubTitle
                </MudText>
            }
            <hr class="wa_hr__purpleGradient" style="margin: 15px 0px 0px 0px;" />
        </TitleContent>
        <DialogContent>
            <DataAnnotationsValidator  />
            <FormDialogValidationHandler @ref="@Validator" />
            @if (!(@Validator?.UnboundError.IsNullOrWhiteSpace() ?? true))
            {
                <MudText Color="Color.Error" Class="wa_formDialog__error">@Validator.UnboundError</MudText>
            }
            @ChildContent
            @if (IsFormDialogSubmitting)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
            }
        </DialogContent>
        <DialogActions>
            @if (!IsFormDialogSubmitting) 
            {
                <MudButton ButtonType="ButtonType.Button" Color="Color.Secondary" OnClick="@OnCancel">Cancel</MudButton>
                <MudButton ButtonType="ButtonType.Submit" Color="Color.Primary">Ok</MudButton>
            }
        </DialogActions>
    </MudDialog>
</EditForm>

@code {
    #nullable enable

    [CascadingParameter]
    protected IMudDialogInstance? MudDialog { get; set; }

    [Parameter, EditorRequired]
    public object Model { get; set; }

    [Parameter, EditorRequired]
    public RenderFragment ChildContent { get; set; }

    [Parameter, EditorRequired]
    public Action OnSubmit { get; set; }

    [Parameter, EditorRequired]
    public string Title { get; set; }

    [Parameter]
    public string? SubTitle { get; set; }

    public bool IsFormDialogSubmitting { get; private set; }

    protected FormDialogValidationHandler? Validator { get; private set; }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            if (ChildContent?.Target is IFormDialogContent formDialogContent)
            {
                formDialogContent.OnValidSubmitCallbackSuccess += ValidSubmitCallbackSuccessHandler;
                formDialogContent.OnValidSubmitCallbackErrorAsync += ValidSubmitCallbackErrorHandlerAsync;
            }
            else
            {
                throw new ArgumentException($"Child content of the {nameof(FormDialog)} component must implement {nameof(IFormDialogContent)}");
            }
        }

        base.OnAfterRender(firstRender);
    }

    protected async Task OnValidSubmitAsync(EditContext editContext)
    {
        try
        {
            if (!editContext.IsModified())
            {
                MudDialog?.Close();
                return;
            }

            if (MudDialog is not null)
            {
                await MudDialog.SetOptionsAsync(MudDialog.Options with { BackdropClick = false });
            }

            IsFormDialogSubmitting = true;
            Validator?.ClearErrors();
            StateHasChanged();
            OnSubmit?.Invoke();
        }
        catch (Exception ex)
        {
            IsFormDialogSubmitting = false;
            Validator?.DisplayException(ex);
            StateHasChanged();
        }
    }

    protected void ValidSubmitCallbackSuccessHandler()
    {
        try
        {
            IsFormDialogSubmitting = false;
            MudDialog?.Close();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            IsFormDialogSubmitting = false;
            Validator?.DisplayException(ex);
            StateHasChanged();
        }
    }


    protected async Task ValidSubmitCallbackErrorHandlerAsync(ApiError error)
    {
        try
        {
            if (MudDialog is not null)
            {
                await MudDialog.SetOptionsAsync(MudDialog.Options with { BackdropClick = true });
            }
            IsFormDialogSubmitting = false;
            Validator?.DisplayApiErrors(error);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            IsFormDialogSubmitting = false;
            Validator?.DisplayException(ex);
            StateHasChanged();
        }
    }

    protected void OnCancel()
    {
        MudDialog?.Cancel();
    }

    public void Dispose()
    {
        if (ChildContent?.Target is IFormDialogContent formDialogContent)
        {
            formDialogContent.OnValidSubmitCallbackSuccess -= ValidSubmitCallbackSuccessHandler;
            formDialogContent.OnValidSubmitCallbackErrorAsync -= ValidSubmitCallbackErrorHandlerAsync;
        }
    }
}
